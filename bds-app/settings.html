<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Settings â€“ AI Photo Studio</title>
<link rel="stylesheet" href="editor.css" />

<!-- Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signOut,
        deleteUser
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    import { 
        getFirestore, 
        doc, 
        getDoc,
        updateDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCM6r66kW9xkBA5rgVcz4sP57N2v2BMbkg",
        authDomain: "ai-photo-studio-24354.firebaseapp.com",
        projectId: "ai-photo-studio-24354",
        storageBucket: "ai-photo-studio-24354.firebasestorage.app",
        messagingSenderId: "411346648650",
        appId: "1:411346648650:web:aefd1b26027ed5e8fab0b3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUID = null;

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "/signin.html";
            return;
        }

        currentUID = user.uid;

        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);

        if (snap.exists()) {
            const data = snap.data();

            document.getElementById("darkModeToggle").checked = data.darkMode ?? true;
            document.getElementById("beforeAfterToggle").checked = data.beforeAfter ?? true;

            // Only PRO can toggle watermark off
            if (data.plan === "free" || !data.plan) {
                document.getElementById("watermarkToggle").checked = true;
                document.getElementById("watermarkToggle").disabled = true;
                document.getElementById("wmNote").innerText = "Pro feature";
            } else {
                document.getElementById("watermarkToggle").checked = data.watermark ?? false;
            }
        }
    });

    // SAVE SETTINGS
    window.saveSettings = async function () {
        const ref = doc(db, "users", currentUID);

        await updateDoc(ref, {
            darkMode: document.getElementById("darkModeToggle").checked,
            beforeAfter: document.getElementById("beforeAfterToggle").checked,
            watermark: document.getElementById("watermarkToggle").checked
        });

        alert("Settings saved!");
    }

    // SIGN OUT
    window.doSignOut = function () {
        signOut(auth).then(() => {
            window.location.href = "/signin.html";
        });
    }

    // DELETE ACCOUNT
    window.deleteMyAccount = async function () {
        if (!confirm("Are you sure? This cannot be undone.")) return;

        const user = auth.currentUser;
        await deleteUser(user);

        alert("Account deleted.");
        window.location.href = "/signin.html";
    }
</script>

<style>
.settings-box {
    max-width: 450px;
    margin: 40px auto;
    padding: 25px;
    background: #111827;
    border: 1px solid #1f2937;
    border-radius: 14px;
}

.settings-box h2 {
    margin-top: 0;
    font-size: 24px;
    font-weight: 700;
    text-align: center;
}

.setting-row {
    display: flex;
    justify-content: space-between;
    margin: 20px 0;
    font-size: 16px;
}

.toggle {
    transform: scale(1.4);
    cursor: pointer;
}

.save-btn {
    width: 100%;
    padding: 14px;
    margin-top: 20px;
    border-radius: 10px;
    background: #4f8cff;
    color: white;
    font-size: 16px;
    font-weight: 700;
    border: none;
    cursor: pointer;
}
.save-btn:hover {
    background: #3d6edf;
}

.signout {
    margin-top: 30px;
    text-align: center;
    cursor: pointer;
    color: #ff5252;
    font-size: 15px;
}

.delete-btn {
    margin-top: 25px;
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    background: #b91c1c;
    color: white;
    border: none;
    font-weight: bold;
    cursor: pointer;
}
.delete-btn:hover {
    background: #991111;
}

.note {
    font-size: 13px;
    color: #9ca3af;
}
</style>
</head>

<body>

<header class="top-bar">
    <h1>Settings</h1>
    <button onclick="window.location.href='/index.html'" class="account-btn">Back</button>
</header>

<div class="settings-box">
    <h2>Your Settings</h2>

    <div class="setting-row">
        <span>Dark Mode</span>
        <input type="checkbox" id="darkModeToggle" class="toggle" />
    </div>

    <div class="setting-row">
        <span>Before/After Slider</span>
        <input type="checkbox" id="beforeAfterToggle" class="toggle" />
    </div>

    <div class="setting-row">
        <span>Watermark</span>
        <input type="checkbox" id="watermarkToggle" class="toggle" />
    </div>
    <p id="wmNote" class="note"></p>

    <button class="save-btn" onclick="saveSettings()">Save Settings</button>

    <div class="signout" onclick="doSignOut()">Sign Out</div>

    <button class="delete-btn" onclick="deleteMyAccount()">Delete Account</button>
</div>

</body>
</html>
