<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Remove Background · AI Photo Studio</title>

<link href="editor.css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet"/>

</head>
<body>

<!-- Top Bar -->
<div class="topbar">
  <div class="logo">AI Photo Studio</div>

  <div>
    <a href="gallery.html" class="account-btn">My Gallery</a>
    <a href="profile.html" class="account-btn">Account</a>
  </div>
</div>

<!-- Upload Section -->
<div class="upload-box" id="uploadSection">
  <img src="icons/icon-remove-background.png" width="85" style="opacity:0.9; margin-bottom:12px;">
  <h2>Remove Background</h2>
  <p>Upload a photo and our AI will instantly remove the background for you.</p>

  <button class="upload-btn" onclick="document.getElementById('uploadInput').click()">Upload Image</button>
  <input type="file" id="uploadInput" accept="image/*" style="display:none;">
</div>

<!-- Preview Section -->
<div class="preview-container" id="previewContainer">

  <div class="preview-box">
    <img id="previewImage" src="" alt="Preview">
  </div>

  <div class="action-buttons">
    <button class="action-btn blue" onclick="removeBackground()">Remove Background</button>
    <button class="action-btn" onclick="resetEditor()">Reset</button>
    <button class="action-btn" onclick="saveFinalImage()">Save</button>
  </div>
</div>

<footer>AI Photo Studio © 2025</footer>

<script type="module">
/* FIREBASE AUTH CHECK — ONLY LOGGED IN USERS ACCESS TOOLS */
import { auth, onAuthStateChanged } from "./firebase-app.js";

onAuthStateChanged(auth, (user) => {
  if (!user) window.location.href = "signin.html";
});
</script>

<!-- Tool Logic -->
<script>
let originalImage = null;

/* When user selects an image */
document.getElementById("uploadInput").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    originalImage = reader.result;

    document.getElementById("previewImage").src = originalImage;
    document.getElementById("uploadSection").style.display = "none";
    document.getElementById("previewContainer").style.display = "block";
  };
  reader.readAsDataURL(file);
});

/* Simple Client-Side Remove BG (no API, free & fast) */
async function removeBackground() {
  const img = document.getElementById("previewImage");

  // Create canvas
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = img.naturalWidth;
  canvas.height = img.naturalHeight;

  ctx.drawImage(img, 0, 0);

  // Very lightweight pseudo remove-bg (keeps subject, removes bright bg)
  const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = pixels.data;

  for (let i = 0; i < data.length; i += 4) {
    const r = data[i], g = data[i+1], b = data[i+2];

    // Detect nearly-white backgrounds
    if (r > 220 && g > 220 && b > 220) {
      data[i+3] = 0; // Transparent
    }
  }

  ctx.putImageData(pixels, 0, 0);

  // ADD WATERMARK FOR FREE USERS
  const wm = "AI Photo Studio Free User";
  ctx.font = "48px Inter";
  ctx.fillStyle = "rgba(255,255,255,0.35)";
  ctx.rotate(-0.3);
  ctx.fillText(wm, canvas.width / 10, canvas.height / 2);
  ctx.rotate(0.3);

  const result = canvas.toDataURL("image/png");
  document.getElementById("previewImage").src = result;
}

/* Reset tool */
function resetEditor() {
  document.getElementById("uploadSection").style.display = "block";
  document.getElementById("previewContainer").style.display = "none";
  document.getElementById("uploadInput").value = "";
}

/* Save Output */
function saveFinalImage() {
  const link = document.createElement("a");
  link.download = "removed-background.png";
  link.href = document.getElementById("previewImage").src;
  link.click();
}
</script>

</body>
</html>
