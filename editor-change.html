<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Change Background · AI Photo Studio</title>

<link rel="stylesheet" href="editor.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet"/>

</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
    <div class="logo">AI Photo Studio</div>

    <div>
        <a href="gallery.html" class="account-btn">My Gallery</a>
        <a href="profile.html" class="account-btn">Account</a>
    </div>
</div>

<!-- UPLOAD AREA -->
<div class="upload-box" id="uploadSection">
    <img src="icons/icon-change-background.png" width="85" style="opacity:0.9; margin-bottom:12px;">
    <h2>Change Background</h2>
    <p>Upload a photo and replace the background in seconds.</p>

    <button class="upload-btn" onclick="document.getElementById('uploadInput').click()">Upload Image</button>
    <input type="file" id="uploadInput" accept="image/*" style="display:none;">

    <h3 style="margin-top:25px; font-weight:600;">Or select a background</h3>

    <div class="bg-picker">
        <div class="bg-option" style="background:#0ea5e9" onclick="selectPreset('#0ea5e9')"></div>
        <div class="bg-option" style="background:#1e293b" onclick="selectPreset('#1e293b')"></div>
        <div class="bg-option" style="background:#0f172a" onclick="selectPreset('#0f172a')"></div>
        <div class="bg-option" style="background:#22c55e" onclick="selectPreset('#22c55e')"></div>
        <div class="bg-option" style="background:url('stock/bg1.jpg')" onclick="selectPresetImage('stock/bg1.jpg')"></div>
        <div class="bg-option" style="background:url('stock/bg2.jpg')" onclick="selectPresetImage('stock/bg2.jpg')"></div>
        <div class="bg-option" style="background:url('stock/bg3.jpg')" onclick="selectPresetImage('stock/bg3.jpg')"></div>
    </div>
</div>

<!-- EDITOR PREVIEW -->
<div class="preview-container" id="previewContainer">

    <div class="preview-box">
        <img id="previewImage" src="" alt="Original Image">
        <canvas id="outputCanvas"></canvas>
    </div>

    <div class="action-buttons">
        <button class="action-btn blue" onclick="applyBackground()">Apply Background</button>
        <button class="action-btn" onclick="resetEditor()">Reset</button>
        <button class="action-btn" onclick="saveFinalImage()">Save</button>
    </div>
</div>

<footer>AI Photo Studio © 2025</footer>

<!-- AUTH CHECK -->
<script type="module">
import { auth, onAuthStateChanged } from "./firebase-app.js";
onAuthStateChanged(auth, (user) => {
    if (!user) window.location.href = "signin.html";
});
</script>

<script>
let originalImage = null;
let selectedBackground = null;

/* FILE UPLOAD → SHOW PREVIEW */
document.getElementById("uploadInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
        originalImage = reader.result;
        document.getElementById("previewImage").src = originalImage;

        document.getElementById("uploadSection").style.display = "none";
        document.getElementById("previewContainer").style.display = "block";
    };
    reader.readAsDataURL(file);
});

/* BACKGROUND PICKER */
function selectPreset(color) {
    selectedBackground = { type: "color", value: color };
}

function selectPresetImage(path) {
    selectedBackground = { type: "image", value: path };
}

/* APPLY BACKGROUND */
function applyBackground() {
    if (!selectedBackground) {
        alert("Select a background first!");
        return;
    }

    const img = document.getElementById("previewImage");
    const canvas = document.getElementById("outputCanvas");
    const ctx = canvas.getContext("2d");

    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;

    // Draw background
    if (selectedBackground.type === "color") {
        ctx.fillStyle = selectedBackground.value;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    } else {
        const bgImg = new Image();
        bgImg.src = selectedBackground.value;
        bgImg.onload = () => {
            ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
            drawForeground();
        };
        return;
    }

    drawForeground();
}

/* Draw foreground with transparency (simple mask — free tool) */
function drawForeground() {
    const img = document.getElementById("previewImage");
    const canvas = document.getElementById("outputCanvas");
    const ctx = canvas.getContext("2d");

    ctx.drawImage(img, 0, 0);

    // Basic background fade-out (simple mask)
    const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = pixels.data;

    for (let i = 0; i < data.length; i += 4) {
        const r = data[i], g = data[i+1], b = data[i+2];
        if (r > 220 && g > 220 && b > 220) {
            data[i+3] = 0;
        }
    }

    ctx.putImageData(pixels, 0, 0);

    // WATERMARK FOR FREE USERS
    ctx.font = "64px Inter";
    ctx.fillStyle = "rgba(255,255,255,0.35)";
    ctx.rotate(-0.3);
    ctx.fillText("AI Photo Studio Free User", canvas.width / 8, canvas.height / 2);
    ctx.rotate(0.3);
}

/* RESET */
function resetEditor() {
    document.getElementById("uploadInput").value = "";
    document.getElementById("previewContainer").style.display = "none";
    document.getElementById("uploadSection").style.display = "block";
    selectedBackground = null;
}

/* SAVE */
function saveFinalImage() {
    const canvas = document.getElementById("outputCanvas");
    const link = document.createElement("a");
    link.download = "background-changed.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
}
</script>

</body>
</html>
